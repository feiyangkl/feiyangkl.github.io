
---
title: "多线程"

date: "2016-07-17 10:29:32"

tags: 
    - iOS
---
## 基本概念

### 进程

* 进程是指在系统中正在运行的一个应用程序
* 每个进程之间是独立的，每个进程均运行在其专用且受保护的内存空间内
* 通过 `活动监视器` 可以查看 `Mac` 系统中所开启的进程

### 线程

* 进程要想执行任务，必须得有线程，进程至少要有一条线程
* 程序启动会默认开启一条线程，这条线程被称为`主线程`或`UI 线程`
* 线程是进程的基本执行单元，进程的所有任务都在线程中执行

<!-- more --> 
## 多线程

* 一个进程中可以开启多条线程，每条线程可以`同时`执行不同的任务
    * `进程` -> 公司
    * `线程` -> 员工
    * `主线程` -> 老板(第一个员工)
* 多线程技术可以提高程序的执行效率

### 多线程原理

* 同一时间，CPU只能处理一条线程，只有一条线程在执行
* **多线程同时执行，其实是CPU快速地在多条线程之间切换**
* 如果CPU调度线程的时间足够快，就造成了多线程并发执行的`假象`
* 如果线程非常多，会在多条线程之间来回切换，消耗大量的 CPU 资源
    * 每个线程被调度的次数会降低
    * 线程的执行效率会下降

![](https://s2.ax1x.com/2019/08/22/macCTK.png)

> iOS 8.0 主线程的默认堆栈大小也是 `512K`

### 多线程优缺点

#### 优点

* 能适当提高程序的执行效率
* 能适当提高资源利用率（CPU、内存利用率）

#### 缺点

* 开启线程需要占用一定的内存空间，如果开启大量的线程，会占用大量的内存空间，降低程序的性能
* 线程越多，CPU在调度线程上的开销就越大
* 程序设计更加复杂：比如线程之间的通信、多线程的数据共享

### 主线程

* 程序启动创建的线程，被称为`主线程`或`UI 线程`
* 主线程的作用
    * 显示/刷新 UI 界面
    * 处理 UI 事件：`点击`、`滚动`、`拖拽`等事件

> 注意：要将`耗时操作`放在后台线程执行，否则会影响 UI 的流畅度，破坏用户体验

* 所有网络访问都是耗时操作！

## iOS中多线程的实现方案

| 方案 | 简介 | 语言 | 线程生命周期 | 使用频率 |
| -- | -- | -- | -- | -- |
| pthread | <ul><li>一套通用的多线程API</li><li>适用于 Unix / Linux / Windows 等系统</li><li>跨平台\可移植</li><li>使用难度大</li></ul> | C | 程序员管理 | 几乎不用 |
| NSThread | <ul><li>使用更加面向对象</li><li>简单易用，可直接操作线程对象</li></ul> | OC | 程序员管理 | 偶尔使用 |
| GCD | <ul><li>旨在替代NSThread等线程技术</li><li>充分利用设备的多核</li></ul> | C | 自动管理 | 经常使用 |
| NSOperation | <ul><li>基于GCD（底层是GCD）</li><li>比GCD多了一些更简单实用的功能</li><li>使用更加面向对象</li></ul> | OC | 自动管理 | 经常使用 |

